SQL> 
SQL> -- 1. Charger l'application bancaire (AppliBank.sql)
SQL> -- dans le schéma de l'utilisateur ORS2
SQL> 
SQL> -- Déjà fait dans ...start.sql
SQL> 
SQL> -- Les index actuels sur l'application
SQL> -- Pour l'instant seul les 3 indexes primary doivent exister
SQL> select table_name, column_name, index_name
  2  from user_ind_columns
  3  where table_name in ('CLIENT',  'COMPTE',	'TRANSACTION')
  4  order by table_name, index_name, column_name;

TABLE_NAME                                                                                                                       COLUMN_NAME                                                            
-------------------------------------------------------------------------------------------------------------------------------- --------------------                                                   
INDEX_NAME                                                                                                                                                                                              
--------------------------------------------------------------------------------------------------------------------------------                                                                        
CLIENT                                                                                                                           CLIENTID                                                               
PK_CLIENT_CLIENTID                                                                                                                                                                                      
                                                                                                                                                                                                        
COMPTE                                                                                                                           COMPTEID                                                               
PK_COMPTE_COMPTEID                                                                                                                                                                                      
                                                                                                                                                                                                        
TRANSACTION                                                                                                                      TRANSACTIONID                                                          
PK_TRANSACTION_TRID                                                                                                                                                                                     
                                                                                                                                                                                                        

SQL> 
SQL>  /*
SQL> TABLE_NAME 		    COLUMN_NAME 	 INDEX_NAME
SQL> ------------------------------ -------------------- ------------------------------
SQL> CLIENT			    CLIENTID		 PK_CLIENT_CLIENTID
SQL> COMPTE			    COMPTEID		 PK_COMPTE_COMPTEID
SQL> TRANSACTION		    TRANSACTIONID	 PK_TRANSACTION_TRID
SQL> */
SQL> 
SQL> -- Ne pas créer les indexes ci-dessous.
SQL> -- Ce sont les indexes qu'on aurait créés si on opérait
SQL> -- un réglage manuel. Lorsque SQLTUNING ADVISOR aura fait
SQL> -- des recommandations, comparez les indexes qu'ils recommandent
SQL> -- avec ceux ci. Ces indexes sont proposées au vu des clauses
SQL> -- WHERE des requêtes à optmiser automatiquement.
SQL> 
SQL> 
SQL> 
SQL> -- vérification du type d'optimiseur
SQL>  show parameter optimizer_mode;

NAME                                 TYPE        VALUE                                                                                                                                                  
------------------------------------ ----------- ------------------------------                                                                                                                         
optimizer_mode                       string      ALL_ROWS                                                                                                                                               
SQL> 
SQL> -- optimizer_mode			     string	 ALL_ROWS
SQL> 
SQL> -- passer en mode all_rows si utile
SQL> set autotrace off
SQL> alter session set optimizer_mode=all_rows ;

Session altered.

SQL> 
SQL> -- calculer les statistiques sur les objets de l'utilisateur
SQL> -- &MYPDBUSER
SQL> execute dbms_stats.gather_schema_stats('&MYPDBUSER');

PL/SQL procedure successfully completed.

SQL> 
SQL> -- Connexion avec au niveau CDB pour prendre un cliché AWR.
SQL> -- La gestion des statistiques se fait au niveau e ma CDB
SQL> connect &MYCDBUSER@&DBALIASCDB/&MYCDBUSERPASS
Enter value for dbaliascdb: dbtptune2
Connected.
SQL> 
SQL> -- Prendre un premier cliché AWR pour délimiter
SQL> -- l'espace de récupération des requêtes.
SQL> set serveroutput on
SQL> variable snapid1 number;
SQL> 
SQL> begin
  2  	     :snapid1	     := dbms_workload_repository.create_snapshot;
  3  	     dbms_output.put_line('snap_id1='||:snapid1);
  4  end;
  5  /
snap_id1=105                                                                                                                                                                                            

PL/SQL procedure successfully completed.

SQL> 
SQL> -- ReConnexion à la  PDB pour utiliser STA
SQL> connect &MYPDBUSER@&DBALIASPDB/&MYPDBUSERPASS
Connected.
SQL> 
SQL> -- reporter le numéro de cliché rendu par le programme ici :
SQL> -- snap_id1=153  ? snap_id1=743
SQL> 
SQL> -- 2. Provoquer de l'activité (requêtes sur l'application bancaire)
SQL> -- dans la base entre deux clichés AWR
SQL> 
SQL> -- Désactiver l'affichage à l'écran des résultats des requêtes.
SQL>  set autotrace &TRACEOPTION
SQL> 
SQL> 
SQL>  col compteid format a24
SQL>  col nom format a20
SQL>  col prenom format a20
SQL>  col ville format a20
SQL>  col adresse format a30
SQL> 
SQL> 
SQL>  -- Lancer plusieurs requêtes
SQL> 
SQL> -- Requête 1:
SQL> -- listing des clients ayant des comptes
SQL>  select cl.clientid, nom, prenom, compteid, typecompte, solde
  2   from client cl, compte co
  3   where cl.clientid=co.clientid;

39060 rows selected.


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 1701175679                                                                                                                                                                             
                                                                                                                                                                                                        
-----------------------------------------------------------------------------                                                                                                                           
| Id  | Operation          | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                           
-----------------------------------------------------------------------------                                                                                                                           
|   0 | SELECT STATEMENT   |        | 38721 |  2684K|   206   (1)| 00:00:01 |                                                                                                                           
|*  1 |  HASH JOIN         |        | 38721 |  2684K|   206   (1)| 00:00:01 |                                                                                                                           
|   2 |   TABLE ACCESS FULL| CLIENT | 17003 |   348K|    68   (0)| 00:00:01 |                                                                                                                           
|   3 |   TABLE ACCESS FULL| COMPTE | 39060 |  1907K|   137   (1)| 00:00:01 |                                                                                                                           
-----------------------------------------------------------------------------                                                                                                                           
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   1 - access("CL"."CLIENTID"="CO"."CLIENTID")                                                                                                                                                          


Statistics
----------------------------------------------------------                                                                                                                                              
         24  recursive calls                                                                                                                                                                            
         17  db block gets                                                                                                                                                                              
       3264  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
       3096  redo size                                                                                                                                                                                  
    2627457  bytes sent via SQL*Net to client                                                                                                                                                           
      29114  bytes received via SQL*Net from client                                                                                                                                                     
       2605  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
      39060  rows processed                                                                                                                                                                             

SQL> 
SQL>  -- Requête 2:
SQL>  -- listing des clients ayant des comptes trié selon l'identifiant et
SQL>  -- le nom du client
SQL>  select cl.clientid, nom, prenom, compteid, typecompte, solde
  2   from client cl, compte co
  3   where cl.clientid=co.clientid
  4   order by clientid , nom;

39060 rows selected.


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 397642463                                                                                                                                                                              
                                                                                                                                                                                                        
--------------------------------------------------------------------------------------                                                                                                                  
| Id  | Operation           | Name   | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                                  
--------------------------------------------------------------------------------------                                                                                                                  
|   0 | SELECT STATEMENT    |        | 38721 |  2684K|       |   862   (1)| 00:00:01 |                                                                                                                  
|   1 |  SORT ORDER BY      |        | 38721 |  2684K|  3208K|   862   (1)| 00:00:01 |                                                                                                                  
|*  2 |   HASH JOIN         |        | 38721 |  2684K|       |   206   (1)| 00:00:01 |                                                                                                                  
|   3 |    TABLE ACCESS FULL| CLIENT | 17003 |   348K|       |    68   (0)| 00:00:01 |                                                                                                                  
|   4 |    TABLE ACCESS FULL| COMPTE | 39060 |  1907K|       |   137   (1)| 00:00:01 |                                                                                                                  
--------------------------------------------------------------------------------------                                                                                                                  
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   2 - access("CL"."CLIENTID"="CO"."CLIENTID")                                                                                                                                                          


Statistics
----------------------------------------------------------                                                                                                                                              
         12  recursive calls                                                                                                                                                                            
          0  db block gets                                                                                                                                                                              
        691  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
          0  redo size                                                                                                                                                                                  
    2769143  bytes sent via SQL*Net to client                                                                                                                                                           
      29139  bytes received via SQL*Net from client                                                                                                                                                     
       2605  SQL*Net roundtrips to/from client                                                                                                                                                          
          1  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
      39060  rows processed                                                                                                                                                                             

SQL> 
SQL> -- Requête 3:
SQL> -- listing des comptes d'un client connaissant son nom
SQL>  select cl.clientid, nom, prenom, compteid, typecompte, solde
  2   from client cl, compte co
  3   where cl.clientid=co.clientid
  4   and nom ='Petit'
  5   order by co.clientid, nom, prenom;

28 rows selected.


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 397642463                                                                                                                                                                              
                                                                                                                                                                                                        
------------------------------------------------------------------------------                                                                                                                          
| Id  | Operation           | Name   | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                          
------------------------------------------------------------------------------                                                                                                                          
|   0 | SELECT STATEMENT    |        |    13 |   923 |   207   (2)| 00:00:01 |                                                                                                                          
|   1 |  SORT ORDER BY      |        |    13 |   923 |   207   (2)| 00:00:01 |                                                                                                                          
|*  2 |   HASH JOIN         |        |    13 |   923 |   206   (1)| 00:00:01 |                                                                                                                          
|*  3 |    TABLE ACCESS FULL| CLIENT |     6 |   126 |    68   (0)| 00:00:01 |                                                                                                                          
|   4 |    TABLE ACCESS FULL| COMPTE | 39060 |  1907K|   137   (1)| 00:00:01 |                                                                                                                          
------------------------------------------------------------------------------                                                                                                                          
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   2 - access("CL"."CLIENTID"="CO"."CLIENTID")                                                                                                                                                          
   3 - filter("NOM"='Petit')                                                                                                                                                                            


Statistics
----------------------------------------------------------                                                                                                                                              
         12  recursive calls                                                                                                                                                                            
          0  db block gets                                                                                                                                                                              
        691  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
          0  redo size                                                                                                                                                                                  
       2692  bytes sent via SQL*Net to client                                                                                                                                                           
        545  bytes received via SQL*Net from client                                                                                                                                                     
          3  SQL*Net roundtrips to/from client                                                                                                                                                          
          1  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
         28  rows processed                                                                                                                                                                             

SQL> 
SQL> 
SQL>  -- Requête 4:
SQL>  -- listing des informations sur les comptes et clients
SQL>  -- dont le solde est négatif
SQL>  select cl.clientid, nom, prenom, compteid, typecompte, solde
  2   from client cl, compte co
  3   where cl.clientid=co.clientid
  4   and solde <0;

no rows selected


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 3128710315                                                                                                                                                                             
                                                                                                                                                                                                        
---------------------------------------------------------------------------------------------------                                                                                                     
| Id  | Operation                    | Name               | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                     
---------------------------------------------------------------------------------------------------                                                                                                     
|   0 | SELECT STATEMENT             |                    |     1 |    71 |   138   (1)| 00:00:01 |                                                                                                     
|   1 |  NESTED LOOPS                |                    |     1 |    71 |   138   (1)| 00:00:01 |                                                                                                     
|   2 |   NESTED LOOPS               |                    |     1 |    71 |   138   (1)| 00:00:01 |                                                                                                     
|*  3 |    TABLE ACCESS FULL         | COMPTE             |     1 |    50 |   137   (1)| 00:00:01 |                                                                                                     
|*  4 |    INDEX UNIQUE SCAN         | PK_CLIENT_CLIENTID |     1 |       |     0   (0)| 00:00:01 |                                                                                                     
|   5 |   TABLE ACCESS BY INDEX ROWID| CLIENT             |     1 |    21 |     1   (0)| 00:00:01 |                                                                                                     
---------------------------------------------------------------------------------------------------                                                                                                     
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   3 - filter("SOLDE"<0)                                                                                                                                                                                
   4 - access("CL"."CLIENTID"="CO"."CLIENTID")                                                                                                                                                          
                                                                                                                                                                                                        
Note                                                                                                                                                                                                    
-----                                                                                                                                                                                                   
   - this is an adaptive plan                                                                                                                                                                           


Statistics
----------------------------------------------------------                                                                                                                                              
          8  recursive calls                                                                                                                                                                            
          0  db block gets                                                                                                                                                                              
        501  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
          0  redo size                                                                                                                                                                                  
        734  bytes sent via SQL*Net to client                                                                                                                                                           
        484  bytes received via SQL*Net from client                                                                                                                                                     
          1  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
          0  rows processed                                                                                                                                                                             

SQL> 
SQL> 
SQL> -- Requête 5:
SQL> -- listing des transactions par compte et client
SQL>  select cl.clientid, nom, prenom, co.compteid, co.typecompte, tr.date_operation,  operation,
  2   optionoperation, montant
  3   from client cl, compte co, transaction tr
  4   where cl.clientid=co.clientid and co.compteid=tr.compteid;

468720 rows selected.


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 3806039989                                                                                                                                                                             
                                                                                                                                                                                                        
-------------------------------------------------------------------------------------------                                                                                                             
| Id  | Operation           | Name        | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                             
-------------------------------------------------------------------------------------------                                                                                                             
|   0 | SELECT STATEMENT    |             |   464K|    52M|       |  2866   (1)| 00:00:01 |                                                                                                             
|*  1 |  HASH JOIN          |             |   464K|    52M|       |  2866   (1)| 00:00:01 |                                                                                                             
|   2 |   TABLE ACCESS FULL | CLIENT      | 17003 |   348K|       |    68   (0)| 00:00:01 |                                                                                                             
|*  3 |   HASH JOIN         |             |   468K|    43M|  2176K|  2793   (1)| 00:00:01 |                                                                                                             
|   4 |    TABLE ACCESS FULL| COMPTE      | 39060 |  1716K|       |   137   (1)| 00:00:01 |                                                                                                             
|   5 |    TABLE ACCESS FULL| TRANSACTION |   468K|    23M|       |  1102   (1)| 00:00:01 |                                                                                                             
-------------------------------------------------------------------------------------------                                                                                                             
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   1 - access("CL"."CLIENTID"="CO"."CLIENTID")                                                                                                                                                          
   3 - access("CO"."COMPTEID"="TR"."COMPTEID")                                                                                                                                                          


Statistics
----------------------------------------------------------                                                                                                                                              
         53  recursive calls                                                                                                                                                                            
         27  db block gets                                                                                                                                                                              
      35674  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
       4888  redo size                                                                                                                                                                                  
   31564032  bytes sent via SQL*Net to client                                                                                                                                                           
     344299  bytes received via SQL*Net from client                                                                                                                                                     
      31249  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
     468720  rows processed                                                                                                                                                                             

SQL> 
SQL> 
SQL>  -- Requête 6:
SQL>  -- listing des transactions par compte et client pour lesquels le solde du compte négatif
SQL>  select cl.clientid, nom, prenom, co.compteid, co.typecompte, tr.date_operation,  operation,
  2   optionoperation, montant
  3   from client cl, compte co, transaction tr
  4   where cl.clientid=co.clientid and co.compteid=tr.compteid
  5   and co.solde <0;

no rows selected


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 4047996969                                                                                                                                                                             
                                                                                                                                                                                                        
----------------------------------------------------------------------------------------------------                                                                                                    
| Id  | Operation                     | Name               | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                    
----------------------------------------------------------------------------------------------------                                                                                                    
|   0 | SELECT STATEMENT              |                    |    13 |  1612 |  1244   (2)| 00:00:01 |                                                                                                    
|*  1 |  HASH JOIN                    |                    |    13 |  1612 |  1244   (2)| 00:00:01 |                                                                                                    
|   2 |   NESTED LOOPS                |                    |     1 |    71 |   138   (1)| 00:00:01 |                                                                                                    
|   3 |    NESTED LOOPS               |                    |     1 |    71 |   138   (1)| 00:00:01 |                                                                                                    
|*  4 |     TABLE ACCESS FULL         | COMPTE             |     1 |    50 |   137   (1)| 00:00:01 |                                                                                                    
|*  5 |     INDEX UNIQUE SCAN         | PK_CLIENT_CLIENTID |     1 |       |     0   (0)| 00:00:01 |                                                                                                    
|   6 |    TABLE ACCESS BY INDEX ROWID| CLIENT             |     1 |    21 |     1   (0)| 00:00:01 |                                                                                                    
|   7 |   TABLE ACCESS FULL           | TRANSACTION        |   468K|    23M|  1102   (1)| 00:00:01 |                                                                                                    
----------------------------------------------------------------------------------------------------                                                                                                    
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   1 - access("CO"."COMPTEID"="TR"."COMPTEID")                                                                                                                                                          
   4 - filter("CO"."SOLDE"<0)                                                                                                                                                                           
   5 - access("CL"."CLIENTID"="CO"."CLIENTID")                                                                                                                                                          


Statistics
----------------------------------------------------------                                                                                                                                              
         29  recursive calls                                                                                                                                                                            
          0  db block gets                                                                                                                                                                              
        507  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
          0  redo size                                                                                                                                                                                  
        984  bytes sent via SQL*Net to client                                                                                                                                                           
        588  bytes received via SQL*Net from client                                                                                                                                                     
          1  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
          0  rows processed                                                                                                                                                                             

SQL> 
SQL> -- Requête 7:
SQL> -- liste des transactions par compte et client connaissant le nom du client
SQL>  select cl.clientid, nom, prenom, co.compteid, co.typecompte, tr.date_operation,  operation,
  2   optionoperation, montant
  3   from client cl, compte co, transaction tr
  4   where cl.clientid=co.clientid and co.compteid=tr.compteid
  5   and cl.nom='Petit';

336 rows selected.


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 2696959377                                                                                                                                                                             
                                                                                                                                                                                                        
-----------------------------------------------------------------------------------                                                                                                                     
| Id  | Operation           | Name        | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                     
-----------------------------------------------------------------------------------                                                                                                                     
|   0 | SELECT STATEMENT    |             |   155 | 18445 |  1311   (2)| 00:00:01 |                                                                                                                     
|*  1 |  HASH JOIN          |             |   155 | 18445 |  1311   (2)| 00:00:01 |                                                                                                                     
|*  2 |   HASH JOIN         |             |    13 |   858 |   206   (1)| 00:00:01 |                                                                                                                     
|*  3 |    TABLE ACCESS FULL| CLIENT      |     6 |   126 |    68   (0)| 00:00:01 |                                                                                                                     
|   4 |    TABLE ACCESS FULL| COMPTE      | 39060 |  1716K|   137   (1)| 00:00:01 |                                                                                                                     
|   5 |   TABLE ACCESS FULL | TRANSACTION |   468K|    23M|  1102   (1)| 00:00:01 |                                                                                                                     
-----------------------------------------------------------------------------------                                                                                                                     
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   1 - access("CO"."COMPTEID"="TR"."COMPTEID")                                                                                                                                                          
   2 - access("CL"."CLIENTID"="CO"."CLIENTID")                                                                                                                                                          
   3 - filter("CL"."NOM"='Petit')                                                                                                                                                                       


Statistics
----------------------------------------------------------                                                                                                                                              
         37  recursive calls                                                                                                                                                                            
          0  db block gets                                                                                                                                                                              
       4693  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
          0  redo size                                                                                                                                                                                  
      23619  bytes sent via SQL*Net to client                                                                                                                                                           
        844  bytes received via SQL*Net from client                                                                                                                                                     
         24  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
        336  rows processed                                                                                                                                                                             

SQL> 
SQL>  -- Requête 8:
SQL>  -- liste des transactions par compte et client connaissant le nom du client et opérées à une date donnée
SQL>  select cl.clientid, nom, prenom, co.compteid, co.typecompte, tr.date_operation,  operation,
  2   optionoperation, montant
  3   from client cl, compte co, transaction tr
  4   where cl.clientid=co.clientid and co.compteid=tr.compteid
  5   and cl.nom='Petit' and date_operation=to_date('27-01-2010', 'DD-MM-YYYY');

no rows selected


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 3152450571                                                                                                                                                                             
                                                                                                                                                                                                        
-----------------------------------------------------------------------------------------------------                                                                                                   
| Id  | Operation                      | Name               | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                   
-----------------------------------------------------------------------------------------------------                                                                                                   
|   0 | SELECT STATEMENT               |                    |     1 |   119 |  1107   (2)| 00:00:01 |                                                                                                   
|   1 |  NESTED LOOPS                  |                    |     1 |   119 |  1107   (2)| 00:00:01 |                                                                                                   
|   2 |   NESTED LOOPS                 |                    |     1 |   119 |  1107   (2)| 00:00:01 |                                                                                                   
|   3 |    NESTED LOOPS                |                    |     1 |    98 |  1106   (2)| 00:00:01 |                                                                                                   
|*  4 |     TABLE ACCESS FULL          | TRANSACTION        |     1 |    53 |  1104   (2)| 00:00:01 |                                                                                                   
|   5 |     TABLE ACCESS BY INDEX ROWID| COMPTE             |     1 |    45 |     2   (0)| 00:00:01 |                                                                                                   
|*  6 |      INDEX UNIQUE SCAN         | PK_COMPTE_COMPTEID |     1 |       |     1   (0)| 00:00:01 |                                                                                                   
|*  7 |    INDEX UNIQUE SCAN           | PK_CLIENT_CLIENTID |     1 |       |     0   (0)| 00:00:01 |                                                                                                   
|*  8 |   TABLE ACCESS BY INDEX ROWID  | CLIENT             |     1 |    21 |     1   (0)| 00:00:01 |                                                                                                   
-----------------------------------------------------------------------------------------------------                                                                                                   
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   4 - filter("DATE_OPERATION"=TO_DATE(' 2010-01-27 00:00:00', 'syyyy-mm-dd hh24:mi:ss'))                                                                                                               
   6 - access("CO"."COMPTEID"="TR"."COMPTEID")                                                                                                                                                          
   7 - access("CL"."CLIENTID"="CO"."CLIENTID")                                                                                                                                                          
   8 - filter("CL"."NOM"='Petit')                                                                                                                                                                       
                                                                                                                                                                                                        
Note                                                                                                                                                                                                    
-----                                                                                                                                                                                                   
   - this is an adaptive plan                                                                                                                                                                           


Statistics
----------------------------------------------------------                                                                                                                                              
         29  recursive calls                                                                                                                                                                            
          0  db block gets                                                                                                                                                                              
       3981  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
          0  redo size                                                                                                                                                                                  
        984  bytes sent via SQL*Net to client                                                                                                                                                           
        654  bytes received via SQL*Net from client                                                                                                                                                     
          1  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
          0  rows processed                                                                                                                                                                             

SQL> 
SQL> 
SQL>  -- Requête 9:
SQL>  -- liste des opération d'un client données de type DEBIT
SQL>  select cl.clientid, nom, prenom, co.compteid, co.typecompte, tr.date_operation,  operation,
  2   optionoperation, montant
  3   from client cl, compte co, transaction tr
  4   where cl.clientid=co.clientid and co.compteid=tr.compteid
  5   and cl.nom='Petit' and operation='DEBIT';

280 rows selected.


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 2696959377                                                                                                                                                                             
                                                                                                                                                                                                        
-----------------------------------------------------------------------------------                                                                                                                     
| Id  | Operation           | Name        | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                     
-----------------------------------------------------------------------------------                                                                                                                     
|   0 | SELECT STATEMENT    |             |    77 |  9163 |  1310   (2)| 00:00:01 |                                                                                                                     
|*  1 |  HASH JOIN          |             |    77 |  9163 |  1310   (2)| 00:00:01 |                                                                                                                     
|*  2 |   HASH JOIN         |             |    13 |   858 |   206   (1)| 00:00:01 |                                                                                                                     
|*  3 |    TABLE ACCESS FULL| CLIENT      |     6 |   126 |    68   (0)| 00:00:01 |                                                                                                                     
|   4 |    TABLE ACCESS FULL| COMPTE      | 39060 |  1716K|   137   (1)| 00:00:01 |                                                                                                                     
|*  5 |   TABLE ACCESS FULL | TRANSACTION |   234K|    11M|  1103   (2)| 00:00:01 |                                                                                                                     
-----------------------------------------------------------------------------------                                                                                                                     
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   1 - access("CO"."COMPTEID"="TR"."COMPTEID")                                                                                                                                                          
   2 - access("CL"."CLIENTID"="CO"."CLIENTID")                                                                                                                                                          
   3 - filter("CL"."NOM"='Petit')                                                                                                                                                                       
   5 - filter("OPERATION"='DEBIT')                                                                                                                                                                      


Statistics
----------------------------------------------------------                                                                                                                                              
         37  recursive calls                                                                                                                                                                            
          0  db block gets                                                                                                                                                                              
       4688  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
          0  redo size                                                                                                                                                                                  
      19408  bytes sent via SQL*Net to client                                                                                                                                                           
        830  bytes received via SQL*Net from client                                                                                                                                                     
         20  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
        280  rows processed                                                                                                                                                                             

SQL> 
SQL> 
SQL>  -- Requête 10:
SQL>  -- total des transaction par client, par compte, par operation
SQL> 
SQL>   select cl.clientid,  co.compteid, operation, sum(montant)
  2   from client cl, compte co, transaction tr
  3   where cl.clientid=co.clientid and co.compteid=tr.compteid
  4   group by cl.clientid,  co.compteid, operation;

78120 rows selected.


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 2068842575                                                                                                                                                                             
                                                                                                                                                                                                        
---------------------------------------------------------------------------------------------                                                                                                           
| Id  | Operation             | Name        | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                           
---------------------------------------------------------------------------------------------                                                                                                           
|   0 | SELECT STATEMENT      |             | 55239 |  4045K|       |  4181   (2)| 00:00:01 |                                                                                                           
|   1 |  HASH GROUP BY        |             | 55239 |  4045K|  4816K|  4181   (2)| 00:00:01 |                                                                                                           
|*  2 |   HASH JOIN           |             | 55239 |  4045K|       |  3205   (2)| 00:00:01 |                                                                                                           
|*  3 |    TABLE ACCESS FULL  | COMPTE      | 39060 |  1144K|       |   137   (1)| 00:00:01 |                                                                                                           
|   4 |    VIEW               | VW_GBC_5    | 55262 |  2428K|       |  3067   (2)| 00:00:01 |                                                                                                           
|   5 |     HASH GROUP BY     |             | 55262 |  1996K|    21M|  3067   (2)| 00:00:01 |                                                                                                           
|   6 |      TABLE ACCESS FULL| TRANSACTION |   468K|    16M|       |  1101   (1)| 00:00:01 |                                                                                                           
---------------------------------------------------------------------------------------------                                                                                                           
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   2 - access("CO"."COMPTEID"="ITEM_1")                                                                                                                                                                 
   3 - filter("CO"."CLIENTID" IS NOT NULL)                                                                                                                                                              


Statistics
----------------------------------------------------------                                                                                                                                              
         47  recursive calls                                                                                                                                                                            
         10  db block gets                                                                                                                                                                              
       4485  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
       1704  redo size                                                                                                                                                                                  
    4284355  bytes sent via SQL*Net to client                                                                                                                                                           
      57847  bytes received via SQL*Net from client                                                                                                                                                     
       5209  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
      78120  rows processed                                                                                                                                                                             

SQL> 
SQL> 
SQL> -- Requête 11:
SQL>  -- total des transaction par client, par compte, par operation
SQL>  -- dont le total est supérieur à 10000
SQL> 
SQL>  select cl.clientid,  tr.compteid, operation, sum(montant)
  2   from client cl, compte co, transaction tr
  3   where cl.clientid=co.clientid and co.compteid=tr.compteid
  4   group by cl.clientid,  tr.compteid, operation
  5   having sum(montant) >10000;

39904 rows selected.


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 1501660477                                                                                                                                                                             
                                                                                                                                                                                                        
--------------------------------------------------------------------------------------------                                                                                                            
| Id  | Operation            | Name        | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                            
--------------------------------------------------------------------------------------------                                                                                                            
|   0 | SELECT STATEMENT     |             |   421K|    26M|       |  8231   (1)| 00:00:01 |                                                                                                            
|*  1 |  FILTER              |             |       |       |       |            |          |                                                                                                            
|   2 |   HASH GROUP BY      |             |   421K|    26M|    35M|  8231   (1)| 00:00:01 |                                                                                                            
|*  3 |    HASH JOIN         |             |   468K|    29M|       |  1242   (2)| 00:00:01 |                                                                                                            
|*  4 |     TABLE ACCESS FULL| COMPTE      | 39060 |  1144K|       |   137   (1)| 00:00:01 |                                                                                                            
|   5 |     TABLE ACCESS FULL| TRANSACTION |   468K|    16M|       |  1101   (1)| 00:00:01 |                                                                                                            
--------------------------------------------------------------------------------------------                                                                                                            
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   1 - filter(SUM("MONTANT")>10000)                                                                                                                                                                     
   3 - access("CO"."COMPTEID"="TR"."COMPTEID")                                                                                                                                                          
   4 - filter("CO"."CLIENTID" IS NOT NULL)                                                                                                                                                              


Statistics
----------------------------------------------------------                                                                                                                                              
         20  recursive calls                                                                                                                                                                            
          0  db block gets                                                                                                                                                                              
       4478  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
          0  redo size                                                                                                                                                                                  
    2088949  bytes sent via SQL*Net to client                                                                                                                                                           
      29857  bytes received via SQL*Net from client                                                                                                                                                     
       2662  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
      39904  rows processed                                                                                                                                                                             

SQL> 
SQL> 
SQL>  -- Requête 12:
SQL> -- balance des transactions par type et par date
SQL>  select  operation, date_operation, sum(montant)
  2   from transaction tr
  3   group by operation, date_operation;

12 rows selected.


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 2290523699                                                                                                                                                                             
                                                                                                                                                                                                        
----------------------------------------------------------------------------------                                                                                                                      
| Id  | Operation          | Name        | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                      
----------------------------------------------------------------------------------                                                                                                                      
|   0 | SELECT STATEMENT   |             |    17 |   340 |  1133   (4)| 00:00:01 |                                                                                                                      
|   1 |  HASH GROUP BY     |             |    17 |   340 |  1133   (4)| 00:00:01 |                                                                                                                      
|   2 |   TABLE ACCESS FULL| TRANSACTION |   468K|  9154K|  1102   (1)| 00:00:01 |                                                                                                                      
----------------------------------------------------------------------------------                                                                                                                      


Statistics
----------------------------------------------------------                                                                                                                                              
          3  recursive calls                                                                                                                                                                            
          5  db block gets                                                                                                                                                                              
       3975  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
        824  redo size                                                                                                                                                                                  
       1023  bytes sent via SQL*Net to client                                                                                                                                                           
        467  bytes received via SQL*Net from client                                                                                                                                                     
          2  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
         12  rows processed                                                                                                                                                                             

SQL> 
SQL> -- Requête 13:
SQL> -- balance des transactions par type
SQL>  select  operation, sum(montant)
  2   from transaction tr
  3   group by operation;


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 2290523699                                                                                                                                                                             
                                                                                                                                                                                                        
----------------------------------------------------------------------------------                                                                                                                      
| Id  | Operation          | Name        | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                      
----------------------------------------------------------------------------------                                                                                                                      
|   0 | SELECT STATEMENT   |             |     2 |    24 |  1132   (4)| 00:00:01 |                                                                                                                      
|   1 |  HASH GROUP BY     |             |     2 |    24 |  1132   (4)| 00:00:01 |                                                                                                                      
|   2 |   TABLE ACCESS FULL| TRANSACTION |   468K|  5492K|  1101   (1)| 00:00:01 |                                                                                                                      
----------------------------------------------------------------------------------                                                                                                                      


Statistics
----------------------------------------------------------                                                                                                                                              
          1  recursive calls                                                                                                                                                                            
          0  db block gets                                                                                                                                                                              
       3973  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
          0  redo size                                                                                                                                                                                  
        708  bytes sent via SQL*Net to client                                                                                                                                                           
        435  bytes received via SQL*Net from client                                                                                                                                                     
          2  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
          2  rows processed                                                                                                                                                                             

SQL> 
SQL>  -- Requête 14:
SQL>  -- Balance des transactions par type pour des compte épargne
SQL>  -- entre deux dates
SQL>  select co.typecompte,  operation, sum(montant)
  2   from client cl, compte co, transaction tr
  3   where cl.clientid=co.clientid and co.compteid=tr.compteid
  4   and tr.date_operation
  5   between to_date('25-01-2010', 'DD-MM-YYYY') and to_date('27-01-2010', 'DD-MM-YYYY')
  6   group by co.typecompte,  operation ;

no rows selected


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 2499624889                                                                                                                                                                             
                                                                                                                                                                                                        
--------------------------------------------------------------------------------------------                                                                                                            
| Id  | Operation            | Name        | Rows  | Bytes |TempSpc| Cost (%CPU)| Time     |                                                                                                            
--------------------------------------------------------------------------------------------                                                                                                            
|   0 | SELECT STATEMENT     |             |     3 |   264 |       |  1453   (2)| 00:00:01 |                                                                                                            
|   1 |  HASH GROUP BY       |             |     3 |   264 |       |  1453   (2)| 00:00:01 |                                                                                                            
|*  2 |   HASH JOIN          |             | 39060 |  3356K|  2104K|  1450   (2)| 00:00:01 |                                                                                                            
|   3 |    VIEW              | VW_GBF_5    | 39060 |  1640K|       |   137   (1)| 00:00:01 |                                                                                                            
|*  4 |     TABLE ACCESS FULL| COMPTE      | 39060 |  1716K|       |   137   (1)| 00:00:01 |                                                                                                            
|*  5 |    TABLE ACCESS FULL | TRANSACTION | 39060 |  1716K|       |  1104   (2)| 00:00:01 |                                                                                                            
--------------------------------------------------------------------------------------------                                                                                                            
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   2 - access("ITEM_1"="TR"."COMPTEID")                                                                                                                                                                 
   4 - filter("CO"."CLIENTID" IS NOT NULL)                                                                                                                                                              
   5 - filter("TR"."DATE_OPERATION"<=TO_DATE(' 2010-01-27 00:00:00', 'syyyy-mm-dd                                                                                                                       
              hh24:mi:ss') AND "TR"."DATE_OPERATION">=TO_DATE(' 2010-01-25 00:00:00',                                                                                                                   
              'syyyy-mm-dd hh24:mi:ss'))                                                                                                                                                                


Statistics
----------------------------------------------------------                                                                                                                                              
        115  recursive calls                                                                                                                                                                            
         10  db block gets                                                                                                                                                                              
       4506  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
       1976  redo size                                                                                                                                                                                  
        515  bytes sent via SQL*Net to client                                                                                                                                                           
        653  bytes received via SQL*Net from client                                                                                                                                                     
          1  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
          0  rows processed                                                                                                                                                                             

SQL> 
SQL>  -- Requête 15:
SQL>  -- un connexion de jointure manque
SQL>  select co.typecompte,  operation, sum(montant)
  2   from client cl, compte co, transaction tr
  3   where cl.clientid=co.clientid
  4   and tr.date_operation
  5   between to_date('25-01-2010', 'DD-MM-YYYY') and to_date('27-01-2010', 'DD-MM-YYYY')
  6   group by co.typecompte,  operation ;

no rows selected


Execution Plan
----------------------------------------------------------                                                                                                                                              
Plan hash value: 383510784                                                                                                                                                                              
                                                                                                                                                                                                        
-------------------------------------------------------------------------------------                                                                                                                   
| Id  | Operation             | Name        | Rows  | Bytes | Cost (%CPU)| Time     |                                                                                                                   
-------------------------------------------------------------------------------------                                                                                                                   
|   0 | SELECT STATEMENT      |             |     3 |   120 |  5439K  (4)| 00:03:33 |                                                                                                                   
|   1 |  HASH GROUP BY        |             |     3 |   120 |  5439K  (4)| 00:03:33 |                                                                                                                   
|   2 |   MERGE JOIN CARTESIAN|             |  1525M|    56G|  5282K  (1)| 00:03:27 |                                                                                                                   
|*  3 |    TABLE ACCESS FULL  | TRANSACTION | 39060 |   762K|  1104   (2)| 00:00:01 |                                                                                                                   
|   4 |    BUFFER SORT        |             | 39060 |   762K|  5438K  (4)| 00:03:33 |                                                                                                                   
|*  5 |     TABLE ACCESS FULL | COMPTE      | 39060 |   762K|   135   (1)| 00:00:01 |                                                                                                                   
-------------------------------------------------------------------------------------                                                                                                                   
                                                                                                                                                                                                        
Predicate Information (identified by operation id):                                                                                                                                                     
---------------------------------------------------                                                                                                                                                     
                                                                                                                                                                                                        
   3 - filter("TR"."DATE_OPERATION"<=TO_DATE(' 2010-01-27 00:00:00',                                                                                                                                    
              'syyyy-mm-dd hh24:mi:ss') AND "TR"."DATE_OPERATION">=TO_DATE(' 2010-01-25                                                                                                                 
              00:00:00', 'syyyy-mm-dd hh24:mi:ss'))                                                                                                                                                     
   5 - filter("CO"."CLIENTID" IS NOT NULL)                                                                                                                                                              


Statistics
----------------------------------------------------------                                                                                                                                              
         22  recursive calls                                                                                                                                                                            
          0  db block gets                                                                                                                                                                              
       3979  consistent gets                                                                                                                                                                            
          0  physical reads                                                                                                                                                                             
          0  redo size                                                                                                                                                                                  
        515  bytes sent via SQL*Net to client                                                                                                                                                           
        625  bytes received via SQL*Net from client                                                                                                                                                     
          1  SQL*Net roundtrips to/from client                                                                                                                                                          
          0  sorts (memory)                                                                                                                                                                             
          0  sorts (disk)                                                                                                                                                                               
          0  rows processed                                                                                                                                                                             

SQL> 
SQL>  set autotrace off
SQL> 
SQL> -- Connexion avec lau niveau CDB pour prendre un cliché AWR
SQL> -- La gestion des statistiques se fait au niveau e ma CDB
SQL> connect &MYCDBUSER@&DBALIASCDB/&MYCDBUSERPASS
Enter value for dbaliascdb: dbtptune2
Connected.
SQL> 
SQL> 
SQL> -- Prendre un deuxième cliché AWR pour délimiter
SQL> -- la fin de l'espace de récupération des requêtes.
SQL> variable snapid2 number;
SQL> set serveroutput on
SQL> 
SQL> begin
  2  	     :snapid2	     := dbms_workload_repository.create_snapshot;
  3  	     dbms_output.put_line('snap_id2='||:snapid2);
  4  end;
  5  /
snap_id2=106                                                                                                                                                                                            

PL/SQL procedure successfully completed.

SQL> 
SQL> -- ReConnexion à la  PDB pour utiliser STA
SQL> connect &MYPDBUSER@&DBALIASPDB/&MYPDBUSERPASS
Connected.
SQL> 
SQL> -- reporter le numéro de cliché rendu par le programme ici :
SQL> -- snap_id2= 154 ? snap_id2=744
SQL> 
SQL> -- Supprimer la tache
SQL> -- Supprimer 1 tache BANK_SQL_TUNING_TASK si elle existe déjà
SQL> execute DBMS_SQLTUNE.DROP_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER');
BEGIN DBMS_SQLTUNE.DROP_TUNING_TASK('BANK_SQL_TUNING_TASK'||'ORS2'); END;

*
ERROR at line 1:
ORA-13605: The specified task or object BANK_SQL_TUNING_TASKORS2 does not exist for the current user. 
ORA-06512: at "SYS.PRVT_ADVISOR", line 3062 
ORA-06512: at "SYS.DBMS_SYS_ERROR", line 86 
ORA-06512: at "SYS.PRVT_ADVISOR", line 7277 
ORA-06512: at "SYS.PRVT_ADVISOR", line 3046 
ORA-06512: at "SYS.DBMS_ADVISOR", line 193 
ORA-06512: at "SYS.DBMS_SQLTUNE", line 1289 
ORA-06512: at line 1 


SQL> execute DBMS_SQLTUNE.DROP_SQLSET('bank_sql_tuning_set'||'&MYPDBUSER');
BEGIN DBMS_SQLTUNE.DROP_SQLSET('bank_sql_tuning_set'||'ORS2'); END;

*
ERROR at line 1:
ORA-13754: "SQL Tuning Set" "bank_sql_tuning_setORS2" does not exist for user "ORS2". 
ORA-06512: at "SYS.DBMS_SQLTUNE_INTERNAL", line 14910 
ORA-06512: at "SYS.DBMS_SYS_ERROR", line 95 
ORA-06512: at "SYS.DBMS_SQLTUNE_UTIL1", line 491 
ORA-06512: at "SYS.DBMS_SQLTUNE_INTERNAL", line 14874 
ORA-06512: at "SYS.DBMS_SQLTUNE", line 7315 
ORA-06512: at line 1 


SQL> -- Si vous avez déjà exécuté ce script, il se peut qu'un
SQL> -- qu'un profile de requête ai déjà été créé. Dans ce cas:
SQL> -- Rechercher puis supprimer le profie s'il existe déjà
SQL> ---
SQL> set linesize 200
SQL> col sql_text format A40
SQL> select name
  2  from dba_sql_profiles
  3  order by name;

no rows selected

SQL> 
SQL> -- Supprimer le(s) profile(s) s'ils ont été trouvés avec la requête
SQL> -- précédente. NomProfile est le résultat de la requête
SQL> -- ci-dessus. Répéter l'action si utile.
SQL> execute DBMS_SQLTUNE.DROP_SQL_PROFILE('NomProfile');
BEGIN DBMS_SQLTUNE.DROP_SQL_PROFILE('NomProfile'); END;

*
ERROR at line 1:
ORA-13833: SQL profile or patch named NomProfile doesn't exist 
ORA-06512: at "SYS.DBMS_SQLTUNE_INTERNAL", line 18804 
ORA-06512: at "SYS.PRVT_SQLPROF_INFRA", line 48 
ORA-06512: at "SYS.DBMS_SQLTUNE", line 10999 
ORA-06512: at line 1 


SQL> 
SQL> -- 3. Générer les recommandations
SQL> -- Exécuter le script ci-dessous pour optimiser automatiquement
SQL> -- les requêtes lancées entre snap_id1 et snap_id2.
SQL> -- Le conseiller qui sera utilisé ici est SQL TUNNING ADVISOR.
SQL> set serveroutput on
SQL> DECLARE
  2  my_task_name VARCHAR2(30);
  3  nom_sqlset varchar2(50):='bank_sql_tuning_set'||'&MYPDBUSER';
  4  l_cursor  DBMS_SQLTUNE.sqlset_cursor;
  5  BEGIN
  6  DBMS_SQLTUNE.CREATE_SQLSET(
  7  sqlset_name => nom_sqlset,
  8  description => 'I/O intensive workload');
  9  
 10  -- Appel de la fonction DBMS_SQLTUNE.select_workload_repository
 11  -- pour recolter les requêtes à régler automatiquement entre
 12  -- snap_id1 et snap_id2.
 13  -- remplacer snap_id1 et snap_id2 par les valeurs capturées
 14  -- plus haut après les appels de:dbms_workload_repository.create_snapshot;.
 15  --1059 et 1174
 16    OPEN l_cursor FOR
 17  	 SELECT VALUE(p)
 18  	 FROM	TABLE (DBMS_SQLTUNE.select_workload_repository (
 19  			 :snapid1, --snap_id1,	-- begin_snap :
 20  			 :snapid2, --snap_id2,	-- end_snap
 21  			 'parsing_schema_name =''&MYPDBUSER''  and parsing_schema_name <> ''SYS''', -- basic_filter
 22  			 NULL, -- object_filter
 23  			 NULL, -- ranking_measure1
 24  			 NULL, -- ranking_measure2
 25  			 NULL, -- ranking_measure3
 26  			 NULL, -- result_percentage
 27  					     NULL, -- result_limit
 28  					     'ALL' -- attribute_list
 29  					     )
 30  		     --    10)	 -- result_limit
 31  		       ) p;
 32  
 33  -- charger les requêtes recoltées entre snap_id1 et snap_id2
 34  -- actuellement présente dans l_cursor dans le sql tuning
 35  -- set créé précédemment.
 36    DBMS_SQLTUNE.load_sqlset (
 37  	 sqlset_name	 => nom_sqlset,
 38  	 populate_cursor => l_cursor);
 39  
 40  -- créer une tâche de tuning pour le sql tuning set
 41  -- alimenté en requête dans l'action ci-dessus.
 42  my_task_name := DBMS_SQLTUNE.CREATE_TUNING_TASK(
 43  sqlset_name => nom_sqlset,
 44  basic_filter => 'parsing_schema_name =''&MYPDBUSER''', -- basic_filter
 45  scope => 'COMPREHENSIVE',
 46  time_limit => 60,
 47  task_name => 'BANK_SQL_TUNING_TASK'||'&MYPDBUSER',
 48  description => 'Task to tune a query on a specified bank queries'
 49  );
 50  
 51  -- Exécuter le tâche de tuning
 52  -- le conseiller utilisé ici est STA.
 53  DBMS_SQLTUNE.EXECUTE_TUNING_TASK( task_name => my_task_name );
 54  
 55  END;
 56  /
old   3: nom_sqlset varchar2(50):='bank_sql_tuning_set'||'&MYPDBUSER';
new   3: nom_sqlset varchar2(50):='bank_sql_tuning_set'||'ORS2';
old  21:                     'parsing_schema_name =''&MYPDBUSER''  and parsing_schema_name <> ''SYS''', -- basic_filter
new  21:                     'parsing_schema_name =''ORS2''  and parsing_schema_name <> ''SYS''', -- basic_filter
old  44: basic_filter => 'parsing_schema_name =''&MYPDBUSER''', -- basic_filter
new  44: basic_filter => 'parsing_schema_name =''ORS2''', -- basic_filter
old  47: task_name => 'BANK_SQL_TUNING_TASK'||'&MYPDBUSER',
new  47: task_name => 'BANK_SQL_TUNING_TASK'||'ORS2',

PL/SQL procedure successfully completed.

SQL> 
SQL> -- profile des fonctions utilisées dans le programme ci-dessus.
SQL> -- A ne pas exécuter. Voir le manuel Oracle Oracle® Database
SQL> -- PL/SQL Packages and Types Reference pour la description
SQL> -- détaillée.
SQL> /*
SQL> DBMS_SQLTUNE.SELECT_WORKLAOD_REPOSITORY (
SQL> begin_snap IN NUMBER,
SQL> end_snap IN NUMBER,
SQL> basic_filter IN VARCHAR2 := NULL,
SQL> object_filter IN VARCHAR2 := NULL,
SQL> ranking_measure1 IN VARCHAR2 := NULL,
SQL> ranking_measure2 IN VARCHAR2 := NULL,
SQL> ranking_measure3 IN VARCHAR2 := NULL,
SQL> result_percentage IN NUMBER := 1,
SQL> result_limit IN NUMBER := NULL
SQL> attribute_list IN VARCHAR2 := NULL)
SQL> RETURN sys.sqlset PIPELINED;
SQL> 
SQL> 
SQL> DBMS_SQLTUNE.CREATE_TUNING_TASK(
SQL> sqlset_name IN VARCHAR2,
SQL> basic_filter IN VARCHAR2 := NULL,
SQL> object_filter IN VARCHAR2 := NULL,
SQL> rank1 IN VARCHAR2 := NULL,
SQL> rank2 IN VARCHAR2 := NULL,
SQL> rank3 IN VARCHAR2 := NULL,
SQL> result_percentage IN NUMBER := NULL,
SQL> result_limit IN NUMBER := NULL,
SQL> scope IN VARCHAR2 := SCOPE_COMPREHENSIVE,
SQL> time_limit IN NUMBER := TIME_LIMIT_DEFAULT,
SQL> task_name IN VARCHAR2 := NULL,
SQL> description IN VARCHAR2 := NULL
SQL> plan_filter IN VARCHAR2 := 'MAX_ELAPSED_TIME',
SQL> sqlset_owner IN VARCHAR2 := NULL)
SQL> RETURN VARCHAR2;
SQL> 
SQL> */
SQL> 
SQL> 
SQL> 
SQL> -- 4. Afficher les résultats d'analyses
SQL> 
SQL> -- Consultation des informations sur la tache
SQL> 
SQL> -- Vérification de la tâche créée
SQL> col task_name format a20
SQL> SELECT task_name
  2  FROM DBA_ADVISOR_LOG
  3  WHERE owner ='ORS2' and task_name='BANK_SQL_TUNING_TASK'||'&MYPDBUSER';
old   3: WHERE owner ='ORS2' and task_name='BANK_SQL_TUNING_TASK'||'&MYPDBUSER'
new   3: WHERE owner ='ORS2' and task_name='BANK_SQL_TUNING_TASK'||'ORS2'

TASK_NAME                                                                                                                                                                                               
--------------------                                                                                                                                                                                    
BANK_SQL_TUNING_TASK                                                                                                                                                                                    
ORS2                                                                                                                                                                                                    
                                                                                                                                                                                                        

SQL> 
SQL> --?
SQL> 
SQL> -- La vue Advisor_tasks contient des informations
SQL> -- sur les tâches
SQL> 
SQL> SELECT TASK_NAME, ADVISOR_NAME, status , RECOMMENDATION_COUNT, SOURCE
  2  FROM USER_ADVISOR_TASKS
  3  WHERE task_name = 'BANK_SQL_TUNING_TASK'||'&MYPDBUSER';
old   3: WHERE task_name = 'BANK_SQL_TUNING_TASK'||'&MYPDBUSER'
new   3: WHERE task_name = 'BANK_SQL_TUNING_TASK'||'ORS2'

TASK_NAME            ADVISOR_NAME                                                                                                                     STATUS      RECOMMENDATION_COUNT                  
-------------------- -------------------------------------------------------------------------------------------------------------------------------- ----------- --------------------                  
SOURCE                                                                                                                                                                                                  
--------------------------------------------------------------------------------------------------------------------------------                                                                        
BANK_SQL_TUNING_TASK SQL Tuning Advisor                                                                                                               COMPLETED                      0                  
ORS2                                                                                                                                                                                                    
PRIMARY                                                                                                                                                                                                 
                                                                                                                                                                                                        

SQL> 
SQL> --?
SQL> 
SQL> -- La vue V$ADVISOR_PROGRESS contient des informations
SQL> -- sur la progression des tâches
SQL> 
SQL> -- Exemple de consultation de la progression
SQL> 
SQL> SELECT sofar, totalwork FROM
  2  V$ADVISOR_PROGRESS  vp,
  3  DBA_ADVISOR_LOG da
  4  WHERE vp.username = '&MYPDBUSER'
  5  AND vp.task_id=da.task_id
  6  AND da.task_name = 'BANK_SQL_TUNING_TASK'||'&MYPDBUSER';
old   4: WHERE vp.username = '&MYPDBUSER'
new   4: WHERE vp.username = 'ORS2'
old   6: AND da.task_name = 'BANK_SQL_TUNING_TASK'||'&MYPDBUSER'
new   6: AND da.task_name = 'BANK_SQL_TUNING_TASK'||'ORS2'

no rows selected

SQL> 
SQL> --?
SQL> 
SQL> --La fonction DBMS_SQLTUNE.REPORT_TUNING_TASK permet d'afficher
SQL> --le résultat d'une analyse
SQL> 
SQL> 
SQL> SET LONG 4000
SQL> SET LONGCHUNKSIZE 4000
SQL> SET LINESIZE 200
SQL> SELECT DBMS_SQLTUNE.REPORT_TUNING_TASK( 'BANK_SQL_TUNING_TASK'||'&MYPDBUSER')
  2  FROM DUAL;
old   1: SELECT DBMS_SQLTUNE.REPORT_TUNING_TASK( 'BANK_SQL_TUNING_TASK'||'&MYPDBUSER')
new   1: SELECT DBMS_SQLTUNE.REPORT_TUNING_TASK( 'BANK_SQL_TUNING_TASK'||'ORS2')

DBMS_SQLTUNE.REPORT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'ORS2')                                                                                                                                         
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
GENERAL INFORMATION SECTION                                                                                                                                                                             
-------------------------------------------------------------------------------                                                                                                                         
Tuning Task Name                  : BANK_SQL_TUNING_TASKORS2                                                                                                                                            
Tuning Task Owner                 : ORS2                                                                                                                                                                
Workload Type                     : SQL Tuning Set                                                                                                                                                      
Scope                             : COMPREHENSIVE                                                                                                                                                       
Time Limit(seconds)               : 60                                                                                                                                                                  
Completion Status                 : COMPLETED                                                                                                                                                           
Started at                        : 02/20/2021 12:48:18                                                                                                                                                 
Completed at                      : 02/20/2021 12:48:33                                                                                                                                                 
SQL Tuning Set (STS) Name         : bank_sql_tuning_setORS2                                                                                                                                             
SQL Tuning Set Owner              : ORS2                                                                                                                                                                
Number of Statements in the STS   : 23                                                                                                                                                                  
                                                                                                                                                                                                        
-------------------------------------------------------------------------------                                                                                                                         
SUMMARY SECTION                                                                                                                                                                                         
-------------------------------------------------------------------------------                                                                                                                         
                      Global SQL Tuning Result Statistics                                                                                                                                               
-------------------------------------------------------------------------------                                                                                                                         
Number of SQLs Analyzed                      : 23                                                                                                                                                       
Number of SQLs in the Report                 : 9                                                                                                                                                        
Number of SQLs with Findings                 : 8                                                                                                                                                        
Number of SQLs with Statistic Findings       : 4                                                                                                                                                        
Number of SQLs with SQL profiles recommended : 2                                                                                                                                                        
Number of SQLs with Index Findings           : 2                                                                                                                                                        
Number of SQLs with Errors                   : 1                                                                                                                                                        
                                                                                                                                                                                                        
-------------------------------------------------------------------------------                                                                                                                         
    SQLs with Findings Ordered by Maximum (Profile/Index) Benefit, Object ID                                                                                                                            
-------------------------------------------------------------------------------                                                                                                                         
object ID  SQL ID        statistics profile(benefit) index(benefit) restructure                                                                                                                         
---------- ------------- ---------- ---------------- -------------- -----------                                                                                                                         
        14 gxmnsabqgkrm7                                     95.95%                                                                                                                                     
        15 3nq3m7wf4nfra                                     95.95%                                                                                                                                     
        19 59jt58gb0dn4n                      11.15%                                                                                                                                                    
        20 3ydv8mqrqsf5v                    <=10.00%                                                                                                                                                    
         8 99qa3zyarxvms          1                                                                                                                                                                     
        21 8zvjs5drd1h4f          1                                                                                                                                                                     
        23 g72kdvcacxvtf          1                                                                                                                                                                     
        24 13fz57d22f59f          1                                                                                                                                                                     
                                                                                                                                                                                                        
-------------------------------------------------------------------------------                                                                                                                         
    Objects with Missing/Stale Statistics (ordered by schema, object, type)                                                                                                                             
-------------------------------------------------------------------------------                                                                                                                         
Schema Name                  Object Name                  Type  State   Cascade                                                                                                                         
---------------------------- ---------------------------- ----- ------- -------                                                                                                                         
                         SYS PLAN_TABLE$                  TABLE MISSING NO                                                                                                                              
                                                                                                                                                                                                        
-------------------------------------------------------------------------------                                                                                                                         
 Tables with New Potential Indices (ordered by schema, number of times, table)                                                                                                                          
-------------------------------------------------------------------------------                                                                                                                         
Schema Name                 Table Name                  Index Name     Nb Time                                                                                                                          
--------------------------- --------------------------- -------------- --------                                                                                                                         
                       ORS2 CLIENT                      IDX$$_00660001        2                                                                                                                         
                            COMPTE                      IDX$$_00660002        2                                                                                                                         
                            TRANSACTION                 IDX$$_00660003        2                                                                                                                         
                                                                                                                                                                                                        
-------------------------------------------------------------------------------                                                                                                                         
                             Statements with Errors                                                                                                                                                     
-------------------------------------------------------------------------------                                                                                                                         
object ID  SQL ID        Error                                                                                                                                                                          
---------- ------------- ------------------------------------------------------                                                                                                                         
         4 g3f3cw3zy5aat ORA-06553: PLS-306: wrong number or types of argume...                                                                                                                         
                                                                                                                                                                                                        
-------------------------------------------------------------------------------                                                                                                                         
DETA                                                                                                                                                                                                    
                                                                                                                                                                                                        

SQL> 
SQL> 
SQL> --?
SQL> 
SQL> -- résultat du report il est conseillée de restructurer la
SQL> -- requête.
SQL> 
SQL> --?
SQL> 
SQL> -- la ligne ci-dessous dans le rapport indique qu'il y'a une
SQL> -- restructuration de la requete à faire.
SQL> -- Number of SQL Restructure Findings: 1
SQL> 
SQL> --
SQL> -- Type de recommandation
SQL> -- Consulter le type de recommandation dans la vue
SQL> -- DBA_ADVISOR_RECOMMENDATIONS
SQL> --
SQL> 
SQL> col task_name format A20
SQL> col PARENT_REC_IDS format A40
SQL> col vs.SQL_TEXT format a60
SQL> col reco_type format A20
SQL> set linesize 200
SQL> set pagesize 400
SQL> 
SQL> 
SQL> select distinct dar.task_name,  vs.sql_id, vs.SQL_TEXT, dar.type reco_type  , BENEFIT
  2  from v$sqlarea vs,
  3  DBA_ADVISOR_SQLPLANS da,
  4  DBA_ADVISOR_RECOMMENDATIONS dar
  5  where vs.sql_id=da.sql_id
  6  and da.task_id=dar.task_id
  7  and dar.task_name='BANK_SQL_TUNING_TASK'||'&MYPDBUSER'
  8  and sql_text not like '%EXPLAIN%'
  9  and sql_text not like '%opt_param%'
 10  and sql_text not like '%insert%'
 11  and sql_text not like '%V_$SESSTAT%'
 12  and sql_text not like '%PLAN_TABLE%'
 13  order by dar.task_name,  vs.sql_id, reco_type;
old   7: and dar.task_name='BANK_SQL_TUNING_TASK'||'&MYPDBUSER'
new   7: and dar.task_name='BANK_SQL_TUNING_TASK'||'ORS2'

TASK_NAME            SQL_ID        SQL_TEXT                                 RECO_TYPE               BENEFIT                                                                                             
-------------------- ------------- ---------------------------------------- -------------------- ----------                                                                                             
BANK_SQL_TUNING_TASK 15xjzmtxth2tq  select cl.clientid, nom, prenom, co.com INDEX                      9595                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid                                                                                                                                                 
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 15xjzmtxth2tq  select cl.clientid, nom, prenom, co.com SQL PROFILE                 597                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid                                                                                                                                                 
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 15xjzmtxth2tq  select cl.clientid, nom, prenom, co.com SQL PROFILE                1115                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid                                                                                                                                                 
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 15xjzmtxth2tq  select cl.clientid, nom, prenom, co.com STATISTICS                    0                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid                                                                                                                                                 
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 18xkf1cs081dr  select cl.clientid,  tr.compteid, opera INDEX                      9595                                                                                             
ORS2                               tion, sum(montant)  from client cl, comp                                                                                                                             
                                   te co, transaction tr  where cl.clientid                                                                                                                             
                                   =co.clientid and co.compteid=tr.compteid                                                                                                                             
                                     group by cl.clientid,  tr.compteid, op                                                                                                                             
                                   eration  having sum(montant) >10000                                                                                                                                  
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 18xkf1cs081dr  select cl.clientid,  tr.compteid, opera SQL PROFILE                 597                                                                                             
ORS2                               tion, sum(montant)  from client cl, comp                                                                                                                             
                                   te co, transaction tr  where cl.clientid                                                                                                                             
                                   =co.clientid and co.compteid=tr.compteid                                                                                                                             
                                     group by cl.clientid,  tr.compteid, op                                                                                                                             
                                   eration  having sum(montant) >10000                                                                                                                                  
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 18xkf1cs081dr  select cl.clientid,  tr.compteid, opera SQL PROFILE                1115                                                                                             
ORS2                               tion, sum(montant)  from client cl, comp                                                                                                                             
                                   te co, transaction tr  where cl.clientid                                                                                                                             
                                   =co.clientid and co.compteid=tr.compteid                                                                                                                             
                                     group by cl.clientid,  tr.compteid, op                                                                                                                             
                                   eration  having sum(montant) >10000                                                                                                                                  
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 18xkf1cs081dr  select cl.clientid,  tr.compteid, opera STATISTICS                    0                                                                                             
ORS2                               tion, sum(montant)  from client cl, comp                                                                                                                             
                                   te co, transaction tr  where cl.clientid                                                                                                                             
                                   =co.clientid and co.compteid=tr.compteid                                                                                                                             
                                     group by cl.clientid,  tr.compteid, op                                                                                                                             
                                   eration  having sum(montant) >10000                                                                                                                                  
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 31dy6fpct29pu  select cl.clientid, nom, prenom, compte INDEX                      9595                                                                                             
ORS2                               id, typecompte, solde  from client cl, c                                                                                                                             
                                   ompte co  where cl.clientid=co.clientid                                                                                                                              
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 31dy6fpct29pu  select cl.clientid, nom, prenom, compte SQL PROFILE                 597                                                                                             
ORS2                               id, typecompte, solde  from client cl, c                                                                                                                             
                                   ompte co  where cl.clientid=co.clientid                                                                                                                              
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 31dy6fpct29pu  select cl.clientid, nom, prenom, compte SQL PROFILE                1115                                                                                             
ORS2                               id, typecompte, solde  from client cl, c                                                                                                                             
                                   ompte co  where cl.clientid=co.clientid                                                                                                                              
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 31dy6fpct29pu  select cl.clientid, nom, prenom, compte STATISTICS                    0                                                                                             
ORS2                               id, typecompte, solde  from client cl, c                                                                                                                             
                                   ompte co  where cl.clientid=co.clientid                                                                                                                              
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 3nq3m7wf4nfra  select cl.clientid, nom, prenom, co.com INDEX                      9595                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid  and cl.nom='Petit'                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 3nq3m7wf4nfra  select cl.clientid, nom, prenom, co.com SQL PROFILE                 597                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid  and cl.nom='Petit'                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 3nq3m7wf4nfra  select cl.clientid, nom, prenom, co.com SQL PROFILE                1115                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid  and cl.nom='Petit'                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 3nq3m7wf4nfra  select cl.clientid, nom, prenom, co.com STATISTICS                    0                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid  and cl.nom='Petit'                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 4bkvmu9937wg8  select  operation, sum(montant)  from t INDEX                      9595                                                                                             
ORS2                               ransaction tr  group by operation                                                                                                                                    
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 4bkvmu9937wg8  select  operation, sum(montant)  from t SQL PROFILE                 597                                                                                             
ORS2                               ransaction tr  group by operation                                                                                                                                    
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 4bkvmu9937wg8  select  operation, sum(montant)  from t SQL PROFILE                1115                                                                                             
ORS2                               ransaction tr  group by operation                                                                                                                                    
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 4bkvmu9937wg8  select  operation, sum(montant)  from t STATISTICS                    0                                                                                             
ORS2                               ransaction tr  group by operation                                                                                                                                    
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 59jt58gb0dn4n  select co.typecompte,  operation, sum(m INDEX                      9595                                                                                             
ORS2                               ontant)  from client cl, compte co, tran                                                                                                                             
                                   saction tr  where cl.clientid=co.clienti                                                                                                                             
                                   d and co.compteid=tr.compteid  and tr.da                                                                                                                             
                                   te_operation  between to_date('25-01-201                                                                                                                             
                                   0', 'DD-MM-YYYY') and to_date('27-01-201                                                                                                                             
                                   0', 'DD-MM-YYYY')  group by co.typecompt                                                                                                                             
                                   e,  operation                                                                                                                                                        
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 59jt58gb0dn4n  select co.typecompte,  operation, sum(m SQL PROFILE                 597                                                                                             
ORS2                               ontant)  from client cl, compte co, tran                                                                                                                             
                                   saction tr  where cl.clientid=co.clienti                                                                                                                             
                                   d and co.compteid=tr.compteid  and tr.da                                                                                                                             
                                   te_operation  between to_date('25-01-201                                                                                                                             
                                   0', 'DD-MM-YYYY') and to_date('27-01-201                                                                                                                             
                                   0', 'DD-MM-YYYY')  group by co.typecompt                                                                                                                             
                                   e,  operation                                                                                                                                                        
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 59jt58gb0dn4n  select co.typecompte,  operation, sum(m SQL PROFILE                1115                                                                                             
ORS2                               ontant)  from client cl, compte co, tran                                                                                                                             
                                   saction tr  where cl.clientid=co.clienti                                                                                                                             
                                   d and co.compteid=tr.compteid  and tr.da                                                                                                                             
                                   te_operation  between to_date('25-01-201                                                                                                                             
                                   0', 'DD-MM-YYYY') and to_date('27-01-201                                                                                                                             
                                   0', 'DD-MM-YYYY')  group by co.typecompt                                                                                                                             
                                   e,  operation                                                                                                                                                        
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 59jt58gb0dn4n  select co.typecompte,  operation, sum(m STATISTICS                    0                                                                                             
ORS2                               ontant)  from client cl, compte co, tran                                                                                                                             
                                   saction tr  where cl.clientid=co.clienti                                                                                                                             
                                   d and co.compteid=tr.compteid  and tr.da                                                                                                                             
                                   te_operation  between to_date('25-01-201                                                                                                                             
                                   0', 'DD-MM-YYYY') and to_date('27-01-201                                                                                                                             
                                   0', 'DD-MM-YYYY')  group by co.typecompt                                                                                                                             
                                   e,  operation                                                                                                                                                        
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 6x3jnwzzucpdj  select  operation, date_operation, sum( INDEX                      9595                                                                                             
ORS2                               montant)  from transaction tr  group by                                                                                                                              
                                   operation, date_operation                                                                                                                                            
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 6x3jnwzzucpdj  select  operation, date_operation, sum( SQL PROFILE                 597                                                                                             
ORS2                               montant)  from transaction tr  group by                                                                                                                              
                                   operation, date_operation                                                                                                                                            
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 6x3jnwzzucpdj  select  operation, date_operation, sum( SQL PROFILE                1115                                                                                             
ORS2                               montant)  from transaction tr  group by                                                                                                                              
                                   operation, date_operation                                                                                                                                            
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 6x3jnwzzucpdj  select  operation, date_operation, sum( STATISTICS                    0                                                                                             
ORS2                               montant)  from transaction tr  group by                                                                                                                              
                                   operation, date_operation                                                                                                                                            
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 9u24nn0mhgcrb   select cl.clientid,  co.compteid, oper INDEX                      9595                                                                                             
ORS2                               ation, sum(montant)  from client cl, com                                                                                                                             
                                   pte co, transaction tr  where cl.clienti                                                                                                                             
                                   d=co.clientid and co.compteid=tr.comptei                                                                                                                             
                                   d  group by cl.clientid,  co.compteid, o                                                                                                                             
                                   peration                                                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 9u24nn0mhgcrb   select cl.clientid,  co.compteid, oper SQL PROFILE                 597                                                                                             
ORS2                               ation, sum(montant)  from client cl, com                                                                                                                             
                                   pte co, transaction tr  where cl.clienti                                                                                                                             
                                   d=co.clientid and co.compteid=tr.comptei                                                                                                                             
                                   d  group by cl.clientid,  co.compteid, o                                                                                                                             
                                   peration                                                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 9u24nn0mhgcrb   select cl.clientid,  co.compteid, oper SQL PROFILE                1115                                                                                             
ORS2                               ation, sum(montant)  from client cl, com                                                                                                                             
                                   pte co, transaction tr  where cl.clienti                                                                                                                             
                                   d=co.clientid and co.compteid=tr.comptei                                                                                                                             
                                   d  group by cl.clientid,  co.compteid, o                                                                                                                             
                                   peration                                                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK 9u24nn0mhgcrb   select cl.clientid,  co.compteid, oper STATISTICS                    0                                                                                             
ORS2                               ation, sum(montant)  from client cl, com                                                                                                                             
                                   pte co, transaction tr  where cl.clienti                                                                                                                             
                                   d=co.clientid and co.compteid=tr.comptei                                                                                                                             
                                   d  group by cl.clientid,  co.compteid, o                                                                                                                             
                                   peration                                                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK c56grtfc9cwn8  select cl.clientid, nom, prenom, compte INDEX                      9595                                                                                             
ORS2                               id, typecompte, solde  from client cl, c                                                                                                                             
                                   ompte co  where cl.clientid=co.clientid                                                                                                                              
                                    order by clientid , nom                                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK c56grtfc9cwn8  select cl.clientid, nom, prenom, compte SQL PROFILE                 597                                                                                             
ORS2                               id, typecompte, solde  from client cl, c                                                                                                                             
                                   ompte co  where cl.clientid=co.clientid                                                                                                                              
                                    order by clientid , nom                                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK c56grtfc9cwn8  select cl.clientid, nom, prenom, compte SQL PROFILE                1115                                                                                             
ORS2                               id, typecompte, solde  from client cl, c                                                                                                                             
                                   ompte co  where cl.clientid=co.clientid                                                                                                                              
                                    order by clientid , nom                                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK c56grtfc9cwn8  select cl.clientid, nom, prenom, compte STATISTICS                    0                                                                                             
ORS2                               id, typecompte, solde  from client cl, c                                                                                                                             
                                   ompte co  where cl.clientid=co.clientid                                                                                                                              
                                    order by clientid , nom                                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK fg4skgcja2cyj SELECT EXTRACTVALUE(VALUE(D), '/row/@op' INDEX                      9595                                                                                             
ORS2                               ), EXTRACTVALUE(VALUE(D), '/row/@dis'),                                                                                                                              
                                   EXTRACTVALUE(VALUE(D), '/row/@par'), EXT                                                                                                                             
                                   RACTVALUE(VALUE(D), '/row/@prt'), EXTRAC                                                                                                                             
                                   TVALUE(VALUE(D), '/row/@dep'), EXTRACTVA                                                                                                                             
                                   LUE(VALUE(D), '/row/@skp') FROM TABLE(XM                                                                                                                             
                                   LSEQUENCE(EXTRACT(XMLTYPE(:B1 ), '/*/dis                                                                                                                             
                                   play_map/row'))) D                                                                                                                                                   
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK fg4skgcja2cyj SELECT EXTRACTVALUE(VALUE(D), '/row/@op' SQL PROFILE                 597                                                                                             
ORS2                               ), EXTRACTVALUE(VALUE(D), '/row/@dis'),                                                                                                                              
                                   EXTRACTVALUE(VALUE(D), '/row/@par'), EXT                                                                                                                             
                                   RACTVALUE(VALUE(D), '/row/@prt'), EXTRAC                                                                                                                             
                                   TVALUE(VALUE(D), '/row/@dep'), EXTRACTVA                                                                                                                             
                                   LUE(VALUE(D), '/row/@skp') FROM TABLE(XM                                                                                                                             
                                   LSEQUENCE(EXTRACT(XMLTYPE(:B1 ), '/*/dis                                                                                                                             
                                   play_map/row'))) D                                                                                                                                                   
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK fg4skgcja2cyj SELECT EXTRACTVALUE(VALUE(D), '/row/@op' SQL PROFILE                1115                                                                                             
ORS2                               ), EXTRACTVALUE(VALUE(D), '/row/@dis'),                                                                                                                              
                                   EXTRACTVALUE(VALUE(D), '/row/@par'), EXT                                                                                                                             
                                   RACTVALUE(VALUE(D), '/row/@prt'), EXTRAC                                                                                                                             
                                   TVALUE(VALUE(D), '/row/@dep'), EXTRACTVA                                                                                                                             
                                   LUE(VALUE(D), '/row/@skp') FROM TABLE(XM                                                                                                                             
                                   LSEQUENCE(EXTRACT(XMLTYPE(:B1 ), '/*/dis                                                                                                                             
                                   play_map/row'))) D                                                                                                                                                   
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK fg4skgcja2cyj SELECT EXTRACTVALUE(VALUE(D), '/row/@op' STATISTICS                    0                                                                                             
ORS2                               ), EXTRACTVALUE(VALUE(D), '/row/@dis'),                                                                                                                              
                                   EXTRACTVALUE(VALUE(D), '/row/@par'), EXT                                                                                                                             
                                   RACTVALUE(VALUE(D), '/row/@prt'), EXTRAC                                                                                                                             
                                   TVALUE(VALUE(D), '/row/@dep'), EXTRACTVA                                                                                                                             
                                   LUE(VALUE(D), '/row/@skp') FROM TABLE(XM                                                                                                                             
                                   LSEQUENCE(EXTRACT(XMLTYPE(:B1 ), '/*/dis                                                                                                                             
                                   play_map/row'))) D                                                                                                                                                   
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK gxmnsabqgkrm7  select cl.clientid, nom, prenom, co.com INDEX                      9595                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid  and cl.nom='Petit'                                                                                                                             
                                    and operation='DEBIT'                                                                                                                                               
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK gxmnsabqgkrm7  select cl.clientid, nom, prenom, co.com SQL PROFILE                 597                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid  and cl.nom='Petit'                                                                                                                             
                                    and operation='DEBIT'                                                                                                                                               
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK gxmnsabqgkrm7  select cl.clientid, nom, prenom, co.com SQL PROFILE                1115                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid  and cl.nom='Petit'                                                                                                                             
                                    and operation='DEBIT'                                                                                                                                               
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK gxmnsabqgkrm7  select cl.clientid, nom, prenom, co.com STATISTICS                    0                                                                                             
ORS2                               pteid, co.typecompte, tr.date_operation,                                                                                                                             
                                     operation,  optionoperation, montant                                                                                                                               
                                   from client cl, compte co, transaction t                                                                                                                             
                                   r  where cl.clientid=co.clientid and co.                                                                                                                             
                                   compteid=tr.compteid  and cl.nom='Petit'                                                                                                                             
                                    and operation='DEBIT'                                                                                                                                               
                                                                                                                                                                                                        

44 rows selected.

SQL> 
SQL> 
SQL> --?
SQL> 
SQL> --
SQL> -- Consultation la description du problème trouvé par STA
SQL> -- Dans la vue DBA_ADVISOR_FINDINGS
SQL> -- Résultation de la recherche
SQL> ---
SQL> 
SQL> col task_name format A10
SQL> col message format A40
SQL> col more_info format A40
SQL> col impact_type format A40
SQL> col vs.SQL_TEXT format a40
SQL> set linesize 300
SQL> set pagesize 400
SQL> 
SQL> select distinct dar.task_name,  da.object_id, vs.sql_id, vs.SQL_TEXT, MESSAGE, impact_type, more_info
  2  from v$sqlarea vs,
  3  DBA_ADVISOR_SQLPLANS da,
  4  DBA_ADVISOR_FINDINGS dar
  5  where vs.sql_id=da.sql_id
  6  and da.task_id=dar.task_id
  7  and da.object_id=dar.object_id
  8  and dar.task_name='BANK_SQL_TUNING_TASK'||'&MYPDBUSER'
  9  and sql_text not like '%EXPLAIN%'
 10  and sql_text not like '%opt_param%'
 11  and sql_text not like '%insert%'
 12  and sql_text not like '%V_$SESSTAT%'
 13  and sql_text not like '%PLAN_TABLE%'
 14  order by dar.task_name,  da.object_id, vs.sql_id;
old   8: and dar.task_name='BANK_SQL_TUNING_TASK'||'&MYPDBUSER'
new   8: and dar.task_name='BANK_SQL_TUNING_TASK'||'ORS2'

TASK_NAME   OBJECT_ID SQL_ID        SQL_TEXT                                 MESSAGE                                  IMPACT_TYPE                              MORE_INFO                                                                                                                                    
---------- ---------- ------------- ---------------------------------------- ---------------------------------------- ---------------------------------------- ----------------------------------------                                                                                                     
BANK_SQL_T         14 gxmnsabqgkrm7  select cl.clientid, nom, prenom, co.com The execution plan of this statement can                                                                                                                                                                                       
UNING_TASK                          pteid, co.typecompte, tr.date_operation,  be improved by creating one or more ind                                                                                                                                                                                       
ORS2                                  operation,  optionoperation, montant   ices.                                                                                                                                                                                                                          
                                    from client cl, compte co, transaction t                                                                                                                                                                                                                                
                                    r  where cl.clientid=co.clientid and co.                                                                                                                                                                                                                                
                                    compteid=tr.compteid  and cl.nom='Petit'                                                                                                                                                                                                                                
                                     and operation='DEBIT'                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                            
BANK_SQL_T         15 3nq3m7wf4nfra  select cl.clientid, nom, prenom, co.com The execution plan of this statement can                                                                                                                                                                                       
UNING_TASK                          pteid, co.typecompte, tr.date_operation,  be improved by creating one or more ind                                                                                                                                                                                       
ORS2                                  operation,  optionoperation, montant   ices.                                                                                                                                                                                                                          
                                    from client cl, compte co, transaction t                                                                                                                                                                                                                                
                                    r  where cl.clientid=co.clientid and co.                                                                                                                                                                                                                                
                                    compteid=tr.compteid  and cl.nom='Petit'                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                            
BANK_SQL_T         19 59jt58gb0dn4n  select co.typecompte,  operation, sum(m A potentially better execution plan was                                                                                                                                                                                        
UNING_TASK                          ontant)  from client cl, compte co, tran found for this statement.                                                                                                                                                                                                      
ORS2                                saction tr  where cl.clientid=co.clienti                                                                                                                                                                                                                                
                                    d and co.compteid=tr.compteid  and tr.da                                                                                                                                                                                                                                
                                    te_operation  between to_date('25-01-201                                                                                                                                                                                                                                
                                    0', 'DD-MM-YYYY') and to_date('27-01-201                                                                                                                                                                                                                                
                                    0', 'DD-MM-YYYY')  group by co.typecompt                                                                                                                                                                                                                                
                                    e,  operation                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                            

SQL> 
SQL> 
SQL> 
SQL> --?
SQL> 
SQL> ---
SQL> --- recommandation
SQL> --- consulter les actions (diagnostic) recommandées par STA
SQL> --- dans la vue DBA_ADVISOR_ACTIONS
SQL> ---
SQL> -- voir
SQL> col task_name format A20
SQL> col message format A40
SQL> col more_info format A40
SQL> col impact_type format A40
SQL> col SQL_TEXT format a40
SQL> 
SQL> set linesize 200
SQL> set pagesize 400
SQL> 
SQL> 
SQL> select distinct dar.task_name,  da.object_id, vs.sql_id, vs.SQL_TEXT, message
  2  from v$sqlarea vs,
  3  DBA_ADVISOR_SQLPLANS da,
  4  DBA_ADVISOR_ACTIONS dar
  5  where vs.sql_id=da.sql_id
  6  and da.task_id=dar.task_id
  7  and da.object_id=dar.object_id
  8  and dar.task_name='BANK_SQL_TUNING_TASK'||'&MYPDBUSER'
  9  and sql_text not like '%EXPLAIN%'
 10  and sql_text not like '%opt_param%'
 11  and sql_text not like '%insert%'
 12  and sql_text not like '%V_$SESSTAT%'
 13  and sql_text not like '%PLAN_TABLE%'
 14  order by dar.task_name, da.object_id, vs.sql_id;
old   8: and dar.task_name='BANK_SQL_TUNING_TASK'||'&MYPDBUSER'
new   8: and dar.task_name='BANK_SQL_TUNING_TASK'||'ORS2'

TASK_NAME             OBJECT_ID SQL_ID        SQL_TEXT                                 MESSAGE                                                                                                          
-------------------- ---------- ------------- ---------------------------------------- ----------------------------------------                                                                         
BANK_SQL_TUNING_TASK         14 gxmnsabqgkrm7  select cl.clientid, nom, prenom, co.com Consider running the Access Advisor to i                                                                         
ORS2                                          pteid, co.typecompte, tr.date_operation, mprove the physical schema design or cre                                                                         
                                                operation,  optionoperation, montant   ating the recommended index.                                                                                     
                                              from client cl, compte co, transaction t                                                                                                                  
                                              r  where cl.clientid=co.clientid and co.                                                                                                                  
                                              compteid=tr.compteid  and cl.nom='Petit'                                                                                                                  
                                               and operation='DEBIT'                                                                                                                                    
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK         15 3nq3m7wf4nfra  select cl.clientid, nom, prenom, co.com Consider running the Access Advisor to i                                                                         
ORS2                                          pteid, co.typecompte, tr.date_operation, mprove the physical schema design or cre                                                                         
                                                operation,  optionoperation, montant   ating the recommended index.                                                                                     
                                              from client cl, compte co, transaction t                                                                                                                  
                                              r  where cl.clientid=co.clientid and co.                                                                                                                  
                                              compteid=tr.compteid  and cl.nom='Petit'                                                                                                                  
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK         19 59jt58gb0dn4n  select co.typecompte,  operation, sum(m Consider accepting the recommended SQL p                                                                         
ORS2                                          ontant)  from client cl, compte co, tran rofile.                                                                                                          
                                              saction tr  where cl.clientid=co.clienti                                                                                                                  
                                              d and co.compteid=tr.compteid  and tr.da                                                                                                                  
                                              te_operation  between to_date('25-01-201                                                                                                                  
                                              0', 'DD-MM-YYYY') and to_date('27-01-201                                                                                                                  
                                              0', 'DD-MM-YYYY')  group by co.typecompt                                                                                                                  
                                              e,  operation                                                                                                                                             
                                                                                                                                                                                                        

SQL> 
SQL> --?
SQL> 
SQL> -- Liste des actions possibles
SQL> set linesize 200
SQL> col ATTR1 format a30
SQL> col ATTR2 format a10
SQL> col attr3 format a20
SQL> col ATTR4 format a10
SQL> col attr5 format a30
SQL> 
SQL> select
  2  object_id,
  3  ATTR1,
  4  ATTR2,
  5  ATTR3,
  6  ATTR4,
  7  ATTR5
  8  from DBA_ADVISOR_ACTIONS
  9  where attr1!='SYS'
 10  and attr1 not like '%SYSMAN%'
 11  order by object_id;

 OBJECT_ID ATTR1                          ATTR2      ATTR3                ATTR4      ATTR5                                                                                                              
---------- ------------------------------ ---------- -------------------- ---------- ------------------------------                                                                                     
        14 ORS2.IDX$$_00660001                       ORS2.CLIENT          BTREE      ("NOM","CLIENTID","PRENOM")                                                                                        
        14 ORS2.IDX$$_00660002                       ORS2.COMPTE          BTREE      ("CLIENTID")                                                                                                       
        14 ORS2.IDX$$_00660003                       ORS2.TRANSACTION     BTREE      ("COMPTEID")                                                                                                       
        15 ORS2.IDX$$_00660004                       ORS2.CLIENT          BTREE      ("NOM","CLIENTID","PRENOM")                                                                                        
        15 ORS2.IDX$$_00660005                       ORS2.COMPTE          BTREE      ("CLIENTID")                                                                                                       
        15 ORS2.IDX$$_00660006                       ORS2.TRANSACTION     BTREE      ("COMPTEID")                                                                                                       
        19 BANK_SQL_TUNING_TASKORS2       19         SQL PROFILE                                                                                                                                        
        20 BANK_SQL_TUNING_TASKORS2       20         SQL PROFILE                                                                                                                                        

8 rows selected.

SQL> 
SQL> 
SQL> ---
SQL> --- Raisonnement
SQL> --- Raisonnement avec des explications complémentaires sur
SQL> --- le problème.
SQL> --- Consulté pour cela la vue DBA_ADVISOR_RATIONALE
SQL> ---
SQL> 
SQL> 
SQL> 
SQL> 
SQL> 
SQL> col task_name format A20
SQL> col message format A40
SQL> col more_info format A40
SQL> col impact_type format A40
SQL> col SQL_TEXT format a40
SQL> set linesize 200
SQL> set pagesize 400
SQL> 
SQL> 
SQL> select distinct dar.task_name,  da.object_id, vs.sql_id, vs.SQL_TEXT, message
  2  from v$sqlarea vs,
  3  DBA_ADVISOR_SQLPLANS da,
  4  DBA_ADVISOR_RATIONALE dar
  5  where vs.sql_id=da.sql_id
  6  and da.task_id=dar.task_id
  7  and da.object_id=dar.object_id
  8  and dar.task_name='BANK_SQL_TUNING_TASK'||'&MYPDBUSER'
  9  and sql_text not like '%EXPLAIN%'
 10  and sql_text not like '%opt_param%'
 11  and sql_text not like '%insert%'
 12  and sql_text not like '%V_$SESSTAT%'
 13  and sql_text not like '%PLAN_TABLE%'
 14  order by dar.task_name,  da.object_id, vs.sql_id;
old   8: and dar.task_name='BANK_SQL_TUNING_TASK'||'&MYPDBUSER'
new   8: and dar.task_name='BANK_SQL_TUNING_TASK'||'ORS2'

TASK_NAME             OBJECT_ID SQL_ID        SQL_TEXT                                 MESSAGE                                                                                                          
-------------------- ---------- ------------- ---------------------------------------- ----------------------------------------                                                                         
BANK_SQL_TUNING_TASK         14 gxmnsabqgkrm7  select cl.clientid, nom, prenom, co.com Creating the recommended indices signifi                                                                         
ORS2                                          pteid, co.typecompte, tr.date_operation, cantly improves the execution plan of th                                                                         
                                                operation,  optionoperation, montant   is statement. However, it might be prefe                                                                         
                                              from client cl, compte co, transaction t rable to run "Access Advisor" using a re                                                                         
                                              r  where cl.clientid=co.clientid and co. presentative SQL workload as opposed to                                                                          
                                              compteid=tr.compteid  and cl.nom='Petit' a single statement. This will allow to g                                                                         
                                               and operation='DEBIT'                   et comprehensive index recommendations w                                                                         
                                                                                       hich takes into account index maintenanc                                                                         
                                                                                       e overhead and additional space consumpt                                                                         
                                                                                       ion.                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK         15 3nq3m7wf4nfra  select cl.clientid, nom, prenom, co.com Creating the recommended indices signifi                                                                         
ORS2                                          pteid, co.typecompte, tr.date_operation, cantly improves the execution plan of th                                                                         
                                                operation,  optionoperation, montant   is statement. However, it might be prefe                                                                         
                                              from client cl, compte co, transaction t rable to run "Access Advisor" using a re                                                                         
                                              r  where cl.clientid=co.clientid and co. presentative SQL workload as opposed to                                                                          
                                              compteid=tr.compteid  and cl.nom='Petit' a single statement. This will allow to g                                                                         
                                                                                       et comprehensive index recommendations w                                                                         
                                                                                       hich takes into account index maintenanc                                                                         
                                                                                       e overhead and additional space consumpt                                                                         
                                                                                       ion.                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK         19 59jt58gb0dn4n  select co.typecompte,  operation, sum(m This attribute adjusts optimizer estimat                                                                         
ORS2                                          ontant)  from client cl, compte co, tran es.                                                                                                              
                                              saction tr  where cl.clientid=co.clienti                                                                                                                  
                                              d and co.compteid=tr.compteid  and tr.da                                                                                                                  
                                              te_operation  between to_date('25-01-201                                                                                                                  
                                              0', 'DD-MM-YYYY') and to_date('27-01-201                                                                                                                  
                                              0', 'DD-MM-YYYY')  group by co.typecompt                                                                                                                  
                                              e,  operation                                                                                                                                             
                                                                                                                                                                                                        
BANK_SQL_TUNING_TASK         19 59jt58gb0dn4n  select co.typecompte,  operation, sum(m This attribute sets parameter OPTIMIZER_                                                                         
ORS2                                          ontant)  from client cl, compte co, tran FEATURES_ENABLE to its default value for                                                                         
                                              saction tr  where cl.clientid=co.clienti  this statement. This enables the latest                                                                         
                                              d and co.compteid=tr.compteid  and tr.da  optimizer features to be used.                                                                                  
                                              te_operation  between to_date('25-01-201                                                                                                                  
                                              0', 'DD-MM-YYYY') and to_date('27-01-201                                                                                                                  
                                              0', 'DD-MM-YYYY')  group by co.typecompt                                                                                                                  
                                              e,  operation                                                                                                                                             
                                                                                                                                                                                                        

SQL> --?
SQL> 
SQL> 
SQL> 
SQL> 
SQL> 
SQL> 
SQL> --
SQL> -- Rechercher s'il y'a des scripts générés
SQL> -- Identifier s'il ya un profile pour cette requête choisie plus
SQL> -- haut.
SQL> -- afficher le script complet ou partiel
SQL> col myscript format a1000
SQL> set long 4000
SQL> select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER', 'ALL') MYSCRIPT from dual;
old   1: select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER', 'ALL') MYSCRIPT from dual
new   1: select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'ORS2', 'ALL') MYSCRIPT from dual

MYSCRIPT                                                                                                                                                                                                
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------                                                                                                                                       
-- Script generated by DBMS_SQLTUNE package, advisor framework --                                                                                                                                       
-- Use this script to implement some of the recommendations    --                                                                                                                                       
-- made by the SQL tuning advisor.                             --                                                                                                                                       
--                                                             --                                                                                                                                       
-- NOTE: this script may need to be edited for your system     --                                                                                                                                       
--       (index names, privileges, etc) before it is executed. --                                                                                                                                       
-----------------------------------------------------------------                                                                                                                                       
execute dbms_stats.gather_table_stats(ownname => 'SYS', tabname => 'PLAN_TABLE$', estimate_percent => DBMS_STATS.AUTO_SAMPLE_SIZE, method_opt => 'FOR ALL COLUMNS SIZE AUTO');                          
execute dbms_sqltune.accept_sql_profile(task_name => 'BANK_SQL_TUNING_TASKORS2', object_id => 19, task_owner => 'ORS2', replace => TRUE);                                                               
execute dbms_sqltune.accept_sql_profile(task_name => 'BANK_SQL_TUNING_TASKORS2', object_id => 20, task_owner => 'ORS2', replace => TRUE);                                                               
create index ORS2.IDX$$_00660001 on ORS2.CLIENT("NOM","CLIENTID","PRENOM");                                                                                                                             
create index ORS2.IDX$$_00660002 on ORS2.COMPTE("CLIENTID");                                                                                                                                            
create index ORS2.IDX$$_00660003 on ORS2.TRANSACTION("COMPTEID");                                                                                                                                       
create index ORS2.IDX$$_00660004 on ORS2.CLIENT("NOM","CLIENTID","PRENOM");                                                                                                                             
create index ORS2.IDX$$_00660005 on ORS2.COMPTE("CLIENTID");                                                                                                                                            
create index ORS2.IDX$$_00660006 on ORS2.TRANSACTION("COMPTEID");                                                                                                                                       
                                                                                                                                                                                                        

SQL> 
SQL> select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER', 'INDEXES') MYSCRIPT from dual;
old   1: select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER', 'INDEXES') MYSCRIPT from dual
new   1: select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'ORS2', 'INDEXES') MYSCRIPT from dual

MYSCRIPT                                                                                                                                                                                                
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------                                                                                                                                       
-- Script generated by DBMS_SQLTUNE package, advisor framework --                                                                                                                                       
-- Use this script to implement some of the recommendations    --                                                                                                                                       
-- made by the SQL tuning advisor.                             --                                                                                                                                       
--                                                             --                                                                                                                                       
-- NOTE: this script may need to be edited for your system     --                                                                                                                                       
--       (index names, privileges, etc) before it is executed. --                                                                                                                                       
-----------------------------------------------------------------                                                                                                                                       
create index ORS2.IDX$$_00660001 on ORS2.CLIENT("NOM","CLIENTID","PRENOM");                                                                                                                             
create index ORS2.IDX$$_00660002 on ORS2.COMPTE("CLIENTID");                                                                                                                                            
create index ORS2.IDX$$_00660003 on ORS2.TRANSACTION("COMPTEID");                                                                                                                                       
create index ORS2.IDX$$_00660004 on ORS2.CLIENT("NOM","CLIENTID","PRENOM");                                                                                                                             
create index ORS2.IDX$$_00660005 on ORS2.COMPTE("CLIENTID");                                                                                                                                            
create index ORS2.IDX$$_00660006 on ORS2.TRANSACTION("COMPTEID");                                                                                                                                       
                                                                                                                                                                                                        

SQL> select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER', 'PROFILES') MYSCRIPT from dual;
old   1: select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER', 'PROFILES') MYSCRIPT from dual
new   1: select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'ORS2', 'PROFILES') MYSCRIPT from dual

MYSCRIPT                                                                                                                                                                                                
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------                                                                                                                                       
-- Script generated by DBMS_SQLTUNE package, advisor framework --                                                                                                                                       
-- Use this script to implement some of the recommendations    --                                                                                                                                       
-- made by the SQL tuning advisor.                             --                                                                                                                                       
--                                                             --                                                                                                                                       
-- NOTE: this script may need to be edited for your system     --                                                                                                                                       
--       (index names, privileges, etc) before it is executed. --                                                                                                                                       
-----------------------------------------------------------------                                                                                                                                       
execute dbms_sqltune.accept_sql_profile(task_name => 'BANK_SQL_TUNING_TASKORS2', object_id => 19, task_owner => 'ORS2', replace => TRUE);                                                               
execute dbms_sqltune.accept_sql_profile(task_name => 'BANK_SQL_TUNING_TASKORS2', object_id => 20, task_owner => 'ORS2', replace => TRUE);                                                               
                                                                                                                                                                                                        

SQL> select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER', 'STATISTICS') MYSCRIPT from dual;
old   1: select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER', 'STATISTICS') MYSCRIPT from dual
new   1: select dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'ORS2', 'STATISTICS') MYSCRIPT from dual

MYSCRIPT                                                                                                                                                                                                
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------                                                                                                                                       
-- Script generated by DBMS_SQLTUNE package, advisor framework --                                                                                                                                       
-- Use this script to implement some of the recommendations    --                                                                                                                                       
-- made by the SQL tuning advisor.                             --                                                                                                                                       
--                                                             --                                                                                                                                       
-- NOTE: this script may need to be edited for your system     --                                                                                                                                       
--       (index names, privileges, etc) before it is executed. --                                                                                                                                       
-----------------------------------------------------------------                                                                                                                                       
execute dbms_stats.gather_table_stats(ownname => 'SYS', tabname => 'PLAN_TABLE$', estimate_percent => DBMS_STATS.AUTO_SAMPLE_SIZE, method_opt => 'FOR ALL COLUMNS SIZE AUTO');                          
                                                                                                                                                                                                        

SQL> 
SQL> -- une autre façon d'afficher le script complet
SQL> set serveroutput on
SQL> begin
  2  dbms_output.put_line(dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER', 'ALL'));
  3  end;
  4  /
old   2: dbms_output.put_line(dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER', 'ALL'));
new   2: dbms_output.put_line(dbms_sqltune.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'ORS2', 'ALL'));
-----------------------------------------------------------------
-- Script generated by DBMS_SQLTUNE package, advisor framework --
-- Use this script to implement some of the recommendations    --
--
made by the SQL tuning advisor.                             --
--                                                             --
-- NOTE: this script may need to be edited for your system     --
--   
(index names, privileges, etc) before it is executed. --
-----------------------------------------------------------------
execute dbms_stats.gather_table_stats(ownname => 'SYS', tabname =>           
'PLAN_TABLE$', estimate_percent => DBMS_STATS.AUTO_SAMPLE_SIZE, method_opt => 'FOR ALL COLUMNS SIZE AUTO');
execute dbms_sqltune.accept_sql_profile(task_name => 'BANK_SQL_TUNING_TASKORS2', object_id  
=> 19, task_owner => 'ORS2', replace => TRUE);
execute dbms_sqltune.accept_sql_profile(task_name => 'BANK_SQL_TUNING_TASKORS2', object_id => 20, task_owner => 'ORS2', replace => TRUE);
create index   
ORS2.IDX$$_00660001 on ORS2.CLIENT("NOM","CLIENTID","PRENOM");
create index ORS2.IDX$$_00660002 on ORS2.COMPTE("CLIENTID");
create index ORS2.IDX$$_00660003 on ORS2.TRANSACTION("COMPTEID");
create    
index ORS2.IDX$$_00660004 on ORS2.CLIENT("NOM","CLIENTID","PRENOM");
create index ORS2.IDX$$_00660005 on ORS2.COMPTE("CLIENTID");
create index ORS2.IDX$$_00660006 on ORS2.TRANSACTION("COMPTEID");
    

PL/SQL procedure successfully completed.

SQL> --?
SQL> 
SQL> -- 5. Gérer le script SQL proposé pour le réglage SQL
SQL> -- Gérer le script SQL proposé pour le réglage SQL : Attention ce script est disponible dans le dossier %ORACLE_BASE%\admin\dpdump
SQL> -- récupérer le script et le mettre dans votre dossier : EXO91
SQL> -- Editer ce script de façon approprié
SQL> declare
  2  mydate varchar2(20):=to_char(sysdate, 'DD_MM_YYYY_HH24_MI_SS');
  3  fname varchar2(300):='STA_Generate_action_script_on_bank_app_'
  4  ||'&MYPDBUSER'|| '_'||mydate||'.sql';
  5  begin
  6  
  7  DBMS_ADVISOR.CREATE_FILE(
  8  DBMS_SQLTUNE.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER'),
  9  'DATA_PUMP_DIR',
 10  fname
 11  );
 12  end;
 13  /
old   4: ||'&MYPDBUSER'|| '_'||mydate||'.sql';
new   4: ||'ORS2'|| '_'||mydate||'.sql';
old   8: DBMS_SQLTUNE.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'&MYPDBUSER'),
new   8: DBMS_SQLTUNE.SCRIPT_TUNING_TASK('BANK_SQL_TUNING_TASK'||'ORS2'),

PL/SQL procedure successfully completed.

SQL> 
SQL> -- exécuter le script pour accepter le profile de la requête choisie
SQL> 
SQL> -- execute dbms_sqltune.accept_sql_profile(task_name => 'BANK_SQL_TUNING_TASK'||'&MYPDBUSER', replace => TRUE);
SQL> 
SQL> ---
SQL> --- Vérifier la présence d'un profie dans la vue
SQL> ---
SQL> set linesize 200
SQL> 
SQL> col sql_text format A40
SQL> select name ,CATEGORY,  SQL_TEXT , STATUS,FORCE_MATCHING
  2  from dba_sql_profiles
  3  order by name;

no rows selected

SQL> 
SQL> 
SQL> SPOOL OFF
